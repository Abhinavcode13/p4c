name: "bazel"

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Cancel any preceding run on the pull request.
concurrency:
  group: bazel-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: ${{ github.ref != 'refs/heads/main' }}

jobs:
  build_direct:  # Build p4c directly.
    runs-on: ubuntu-latest
    env:
      BAZEL: bazelisk-linux-amd64
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Cache Bazel
      uses: actions/cache@v4 # v4.0.0
      env:
        cache-name: bazel-cache
      with:
        path: ~/.cache/bazel
        # formattedTime here is like 2021323 - the year concatenated with the week then
        # the day of that week.
        # As this changes every day, we cycle to a new cache once per day, with lookup
        # across the week (and then the year).
        # This is the gRPC caching strategy: https://github.com/grpc/grpc/blob/b2b6af691ed7bb923d8288a05167526d946ea1eb/.github/workflows/pr-auto-fix.yaml#L24
        key: ${{ runner.os }}-${{ steps.current-time-with-day.outputs.formattedTime }}
        restore-keys: |
          ${{ runner.os }}-${{ steps.current-time.outputs.formattedTime }}
          ${{ runner.os }}-

    - name: First, pass the lint test
      run: bazel run //:buildifier_check

    - name: Install Flex and Bison
      run: sudo apt-get update && sudo apt-get install bison flex libfl-dev

    - name: Build p4c
      run: bazel build //... --verbose_failures

  build_indirect:  # Build 3rd party Bazel project depending on p4c as a subproject.
    runs-on: ubuntu-latest
    env:
      BAZEL: bazelisk-linux-amd64
    steps:
    - uses: actions/checkout@v3
      with:
        submodules: recursive

    - name: Cache Bazel
      uses: actions/cache@v4 # v4.0.0
      env:
        cache-name: bazel-cache
      with:
        path: ~/.cache/bazel
        # formattedTime here is like 2021323 - the year concatenated with the week then
        # the day of that week.
        # As this changes every day, we cycle to a new cache once per day, with lookup
        # across the week (and then the year).
        # This is the gRPC caching strategy: https://github.com/grpc/grpc/blob/b2b6af691ed7bb923d8288a05167526d946ea1eb/.github/workflows/pr-auto-fix.yaml#L24
        key: ${{ runner.os }}-${{ steps.current-time-with-day.outputs.formattedTime }}
        restore-keys: |
          ${{ runner.os }}-${{ steps.current-time.outputs.formattedTime }}
          ${{ runner.os }}-

    - name: First, pass the lint test
      run: bazel run //:buildifier_check

    - name: Install Flex and Bison
      run: sudo apt-get update && sudo apt-get install bison flex libfl-dev

    - name: Build bazel/example
      run: cd ./bazel/example && bazel build //... --verbose_failures
